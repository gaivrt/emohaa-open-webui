# Emohaa WebUI 图标更新指南

## 📋 概述

本指南详细说明如何更新 Emohaa WebUI 项目中的所有图标文件，包括 favicon、PWA 图标、启动画面等。

## 🎯 准备工作

### 前置条件
- 确保已安装 ImageMagick 工具用于图像处理
- 准备好新的图标文件（建议尺寸：256x256 或更大，PNG格式）
- 确保图标文件大小合理（建议小于100KB）

### 安装 ImageMagick（如需要）
```bash
sudo apt update && sudo apt install -y imagemagick
```

## 📂 文件结构说明

项目中图标文件的位置：
```
emohaa-webui/
├── static/                          # 前端静态文件目录
│   ├── favicon.png                   # 主favicon（用于生成其他格式）
│   ├── favicon-*.png                 # 各种尺寸的favicon
│   ├── icon-*.png                    # PWA图标
│   ├── apple-touch-icon.png          # iOS图标
│   ├── splash*.png                   # 启动画面
│   └── static/                       # 嵌套static目录
│       └── (所有图标文件的副本)
└── static/static/                    # 后端静态文件目录
    └── (所有图标文件)
```

## 🔧 更新步骤

### 第1步：准备新图标文件

1. 将新的图标文件保存为 `new-favicon.png`
2. 确保图标清晰且适合小尺寸显示
3. 检查文件大小（建议 < 100KB）

### 第2步：压缩和优化图标

```bash
# 进入项目根目录
cd /path/to/emohaa-webui

# 压缩图标到合理大小（如果原文件过大）
convert new-favicon.png -resize 256x256 -quality 85 favicon_compressed.png

# 检查压缩后的文件大小
ls -lh favicon_compressed.png
```

### 第3步：生成所有格式的图标

```bash
# 使用压缩后的文件作为源文件
cp favicon_compressed.png static/favicon.png

# 生成各种尺寸的PNG文件
convert static/favicon.png -resize 96x96 static/favicon-96x96.png
convert static/favicon.png -resize 32x32 static/favicon.ico
convert static/favicon.png -resize 180x180 static/apple-touch-icon.png
convert static/favicon.png -resize 192x192 static/icon-192.png
convert static/favicon.png -resize 512x512 static/icon-512.png

# 生成启动画面图标
convert static/favicon.png -resize 200x200 static/splash.png
cp static/splash.png static/splash-dark.png

# 生成SVG（作为PNG备用）
cp static/favicon.png static/favicon.svg
```

### 第4步：复制到所有必要位置

```bash
# 复制到后端静态文件目录
mkdir -p static/static
cp static/favicon* static/static/
cp static/icon-* static/static/
cp static/apple-touch-icon.png static/static/
cp static/splash*.png static/static/

# 确保嵌套static目录也有副本
cp static/favicon* static/static/
cp static/icon-* static/static/
cp static/apple-touch-icon.png static/static/
cp static/splash*.png static/static/
```

### 第5步：更新配置文件

#### 更新 PWA Manifest (`static/manifest.json`)
```json
{
  "name": "Emohaa",
  "short_name": "Emohaa",
  "description": "Emohaa AI Assistant",
  "start_url": "/",
  "display": "standalone",
  "background_color": "#ffffff",
  "theme_color": "#000000",
  "icons": [
    {
      "src": "/static/favicon.png",
      "sizes": "any",
      "type": "image/png"
    },
    {
      "src": "/static/favicon-96x96.png",
      "sizes": "96x96",
      "type": "image/png"
    },
    {
      "src": "/static/apple-touch-icon.png",
      "sizes": "180x180",
      "type": "image/png"
    },
    {
      "src": "/static/icon-192.png",
      "sizes": "192x192",
      "type": "image/png"
    },
    {
      "src": "/static/icon-512.png",
      "sizes": "512x512",
      "type": "image/png"
    }
  ]
}
```

#### 更新 OpenSearch 配置 (`static/opensearch.xml`)
```xml
<?xml version="1.0" encoding="UTF-8"?>
<OpenSearchDescription xmlns="http://a9.com/-/spec/opensearch/1.1/">
<ShortName>Emohaa</ShortName>
<Image width="16" height="16" type="image/x-icon">/static/favicon.png</Image>
<Url type="text/html" method="get" template="/"/>
<Description>Emohaa AI Assistant</Description>
</OpenSearchDescription>
```

#### 更新 HTML 模板 (`src/app.html`)
确保以下部分正确：
```html
<link rel="icon" type="image/png" href="/static/favicon.png" />
<link rel="icon" type="image/png" href="/static/favicon-96x96.png" sizes="96x96" />
<link rel="icon" type="image/svg+xml" href="/static/favicon.svg" />
<link rel="shortcut icon" href="/static/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png" />
<meta name="apple-mobile-web-app-title" content="Emohaa" />
<meta name="description" content="Emohaa AI Assistant" />
<title>Emohaa</title>
```

### 第6步：更新前端代码引用（如需要）

如果添加了新的图标引用，确保使用正确的常量：

在 `src/lib/constants.ts` 中：
```typescript
export const FAVICON_URL = browser ? (dev ? '/static/favicon.png' : `${WEBUI_BASE_URL}/static/favicon.png`) : '/static/favicon.png';
```

在组件中导入并使用：
```typescript
import { FAVICON_URL } from '$lib/constants';

// 使用
src={FAVICON_URL}
```

### 第7步：清理和更新时间戳

```bash
# 清理临时文件
rm -f favicon_compressed.png new-favicon.png

# 更新所有文件的时间戳，强制浏览器重新加载
touch static/* static/static/*
```

### 第8步：测试和验证

1. **重启开发服务器**：
   ```bash
   # 停止前端服务器 (Ctrl+C)
   # 重新启动
   yarn dev
   ```

2. **测试前端服务器**：
   ```bash
   curl -I http://127.0.0.1:5173/static/favicon.png
   ```
   应该返回 `200 OK`

3. **硬刷新浏览器**：
   - Windows/Linux: `Ctrl + F5`
   - Mac: `Cmd + Shift + R`

4. **验证图标显示**：
   - 浏览器标签页图标
   - 侧边栏"新对话"按钮图标
   - 主页中间的占位符图标
   - 用户头像默认图标

## ⚠️ 注意事项

### 文件大小
- 主favicon建议 < 100KB
- ICO文件建议 < 10KB
- 总体图标文件包建议 < 500KB

### 浏览器缓存
- 图标更新后可能需要强制刷新浏览器
- 某些浏览器可能缓存图标较长时间
- 可以在开发者工具中勾选"Disable cache"

### CORS问题
- 开发模式下，图标从前端服务器(5173端口)加载
- 生产模式下，图标从后端服务器加载
- 确保两个位置都有正确的文件

### 质量检查清单
- [ ] 所有尺寸的图标都已生成
- [ ] 文件大小合理
- [ ] 复制到所有必要位置
- [ ] 配置文件已更新
- [ ] 浏览器测试通过
- [ ] 移动端PWA图标正常
- [ ] 无CORS错误

## 🔄 回滚操作

如果新图标有问题，可以快速回滚：

```bash
# 恢复备份（如果有的话）
cp static/favicon_backup.png static/favicon.png

# 或者使用Git恢复
git checkout HEAD -- static/ src/app.html static/manifest.json static/opensearch.xml

# 重新生成所有格式
# 执行第3-4步的命令
```

## 📞 故障排除

### 常见问题

1. **图标不显示**
   - 检查文件路径是否正确
   - 验证文件权限
   - 清理浏览器缓存

2. **CORS错误**
   - 确保前端static目录有图标文件
   - 检查FAVICON_URL常量配置

3. **文件过大**
   - 使用ImageMagick压缩
   - 调整质量参数
   - 考虑使用更小的源图片

4. **某些图标不更新**
   - 检查所有文件位置是否都有更新
   - 重启开发服务器
   - 使用无痕浏览模式测试

---

**最后更新**: 2025-07-23  
**维护者**: AI Assistant  
**版本**: 1.0